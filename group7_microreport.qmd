---
title: "Lab 7 Assignment: Group 07"
format:
  html:
    embed-resources: true
editor: visual
author:
  - name: María Vizcaya Garrido - s253703
  - name: Marianna Gordin - s250440
  - name: Angel Molina Guillen - s253697
  - name: Louise Kirkegaard - s215038
  - name: Renata Piatkova - s250186
---

# Libraries

```{r}
#| warning: false 
library("tidyverse")
library("broom")
library("ggrepel")
```

# Load data

```{r}
#| label: Data loading
raw_dir <- "data/_raw/"
data_file <- "gravier.RData"
data_loc <- "https://github.com/ramhiser/datamicroarray/raw/master/data/"

if( !dir.exists(raw_dir) ){
  dir.create(path = raw_dir)
}
if( !file.exists(str_c(raw_dir, data_file)) ){
  download.file(
    url = str_c(data_loc, data_file),
    destfile = str_c(raw_dir, data_file))
}
load(file = str_c(raw_dir, data_file))

```

# Data wrangling

```{r}
#| label: Data wrangling
#Cleaning the data, following the steps from the book
gravier_clean <- gravier |>
  bind_cols() |>
  as_tibble()

write_csv2(file = "02_gravier_clean.gz", x = gravier_clean)

#Augmenting the data
gravier_clean_aug <- gravier_clean |>
  mutate(y = case_when(y == "poor" ~ 1,
                       y == "good" ~ 0)) |> 
  relocate(early_metastasis = y)

write_csv2(file = "03_gravier_clean_aug.gz", x = gravier_clean_aug)

```

# Data analysis 

```{r}
#| label: Data analysis
gravier_clean_aug_long <- gravier_clean_aug |> 
        pivot_longer(cols = starts_with("g"),
                     names_to = "gene",
                     values_to = "log2_expr_lvl")

gravier_clean_aug_long_nested <- gravier_clean_aug_long |> 
        group_by(gene) |> 
        nest() |> 
        ungroup()

gravier_clean_aug_long_nested <- gravier_clean_aug_long_nested |> 
        group_by(gene) |> 
        mutate(model_object = map(.x = data,
                                  .f = ~lm(formula = log2_expr_lvl ~ early_metastasis, data = .x))
               )

gravier_clean_aug_long_nested <- gravier_clean_aug_long_nested |> 
        group_by(gene) |> 
        mutate(model_object = map(.x = data,
                                  .f = ~lm(formula = log2_expr_lvl ~ early_metastasis, data = .x)),
               model_object_tidy = map(.x = model_object,
                                       .f = ~tidy(.x, conf.int = T, conf.level = 0.95)))

gravier_estimates <- gravier_clean_aug_long_nested |> 
        unnest(model_object_tidy)

gravier_estimates <- gravier_estimates |> 
        filter(term == "early_metastasis") |> 
        select(gene, p.value, estimate, conf.low, conf.high) |> 
        ungroup()

gravier_estimates <- gravier_estimates |> 
        mutate(q.value = p.adjust(p.value),
               is_significant = if_else(q.value <= 0.05, "yes", "no")) 

```

# Plots

Now, finally, we get to the part where we can see the fruits of our labor and get to answer the question for this lab: **What genes are significantly up- or down-regulated between the patients with/without early metastasis?**

Using $⍺ = 0.05$ as the threshold for significance we get the following plots:

## Volcano plot

hola

## Forest plot

```{r}
gravier_estimates |>
        filter(is_significant == "yes") |>
        mutate(gene = fct_reorder(gene, estimate)) |>
        ggplot(aes(x = estimate, y = gene)) +
        geom_point() +
        geom_errorbarh(aes(xmin = conf.low, xmax = conf.high)) +
        geom_vline(xintercept = 0) +
        labs(
                title = "Genes Associated with Early Metastasis in Small Node-Negative Breast Carcinoma",
                caption = "data from DOI: 10.1002/gcc.20820",
                y = "",
                x = "Estimates (95%CIs)"
        ) +
        theme_minimal()
```

This forest plot represents 43 genes that were either up-/down-regulated. To the left of the plot we see the down-regulated and on the right we see the up-regulated genes.

Here, ‘Estimate’ denotes the statistical association (effect size) between each gene and early metastasis risk, with the horizontal bars representing the confidence interval for each gene’s estimated effect.

Just to make an observation, we can see that the g1CNS91 is highly up-regulated in patients with Early metastasis in this specific cancer.
